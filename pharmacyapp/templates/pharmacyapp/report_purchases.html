{% extends 'pharmacyapp/base.html' %}

{% block body_block %}
<div class="row">
    <div class="col-md-4">
        <form method="POST" class="report-form">
            {% csrf_token %}
            <h3>Purchase Report</h3>

            <div class="mb-3">
                {{ form.startDate.label_tag }}
                <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-calendar-event"></i></span>
                    {{ form.startDate }}
                </div>
            </div>

            <div class="mb-3">
                {{ form.endDate.label_tag }}
                <div class="input-group">
                    <span class="input-group-text"><i class="bi bi-calendar-event"></i></span>
                    {{ form.endDate }}
                </div>
            </div>

            <div class="mb-3">
                <label for="{{ form.medicineName.id_for_label }}">Medicine</label>
                <select name="{{ form.medicineName.html_name }}" id="{{ form.medicineName.id_for_label }}" class="form-select">
                    <option value="">{{ form.medicineName.empty_label }}</option>
                    {% for med in form.fields.medicineName.queryset %}
                    <option value="{{ med.id }}" {% if form.medicineName.value|stringformat:"s" == med.id|stringformat:"s" %}selected{% endif %}>{{ med.medicineName }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="mb-3">
                {{ form.batchNo.label_tag }}
                {{ form.batchNo }}
            </div>

            <button type="submit" class="btn btn-primary" name="custom" value="custom">Search</button>
        </form>

        <!-- Export CSV Button -->
        <form method="POST" class="d-inline">
            {% csrf_token %}
            <input type="hidden" name="startDate" value="{{ form.startDate.value|default:'' }}">
            <input type="hidden" name="endDate" value="{{ form.endDate.value|default:'' }}">
            <input type="hidden" name="medicineName" value="{{ form.medicineName.value|default:'' }}">
            <input type="hidden" name="batchNo" value="{{ form.batchNo.value|default:'' }}">
            <button type="submit" name="export_csv" value="1" class="btn btn-secondary mt-2">Export CSV</button>
        </form>

        {% if messages %}
        <ul class="messages mt-3">
            {% for message in messages %}
                <li{% if message.tags %} class="{{ message.tags }}"{% endif %}>{{ message }}</li>
            {% endfor %}
        </ul>
        {% endif %}
    </div>

    <div class="col-md-8">
        <div id="printarea">
            <table class="table table-striped" id="purchase-report">
                <caption><h1>Purchase Report</h1></caption>
                <thead>
                    <tr>
                        <th>Date of Purchase</th>
                        <th>Medicine</th>
                        <th>Batch No</th>
                        <th>Quantity (Strips)</th>
                        <th>Pack Size</th>
                        <th>Total Tablets</th>
                        <th>Price per Strip</th>
                    </tr>
                </thead>
                <tbody>
                    {% if reports %}
                        {% for report in reports %}
                        <tr>
                            <td>{{ report.dateOfPurchase }}</td>
                            <td>{{ report.medicine.medicineName }}</td>
                            <td>{{ report.batchNo }}</td>
                            <td>{{ report.quantity }}</td>
                            <td>{{ report.pack }}</td>
                            <td>{{ report.noOfTablets }}</td>
                            <td>{{ report.pricePerStrip }}</td>
                        </tr>
                        {% endfor %}
                        <!-- Totals Row -->
                        <tr>
                            <th>Total</th>
                            <td></td>
                            <td></td>
                            <th>{{ total_quantity }}</th>
                            <td></td>
                            <th>{{ total_tablets }}</th>
                            <th>{{ total_cost }}</th>
                        </tr>
                    {% else %}
                        <tr><td colspan="7" class="text-center">No records found.</td></tr>
                    {% endif %}
                </tbody>
            </table>
        </div>

        {% if user.is_authenticated %}
        <button type="button" class="btn btn-primary" onclick="printDiv('printarea')">Print</button>
        {% endif %}
    </div>
</div>

{% endblock %}
